# Unison Implementation Plan

> **For Claude:** Implement this plan task-by-task with verification after each.

**Goal:** Add unison feature to OSC1 - stack 2/4/8 detuned voices with stereo spread for thick supersaw sounds

**Architecture:** Parallel oscillator bank that replaces MonoSynth oscillator when enabled, routing through existing filter/effects

**Tech Stack:** TypeScript, Tone.js (Oscillator, Panner, AmplitudeEnvelope)

---

## Overview

Unison stacks multiple detuned oscillator voices to create thick, wide sounds. Voices are distributed symmetrically around the center pitch and panned across the stereo field.

**Parameters:**
- `enabled: boolean` - Toggle on/off
- `voices: 2 | 4 | 8` - Number of stacked voices
- `detune: number` - Spread in cents (0-100)
- `spread: number` - Stereo width (0-1)

---

## Task 1: Add Types

**Files:**
- Modify: `src/core/types.ts`

**Add UnisonParams interface:**
```typescript
export interface UnisonParams {
  enabled: boolean;
  voices: 2 | 4 | 8;
  detune: number;  // cents, 0-100
  spread: number;  // 0-1
}
```

**Add to SynthParams:**
```typescript
unison: UnisonParams;
```

**Add defaults to DEFAULT_SYNTH_PARAMS:**
```typescript
unison: {
  enabled: false,
  voices: 4,
  detune: 20,
  spread: 0.5,
},
```

**Verification:** `npx tsc --noEmit`

---

## Task 2: Add Engine Unison Support

**Files:**
- Modify: `src/core/synth-engine.ts`

**Add private members:**
```typescript
// Unison oscillator bank
private unisonOscs: Tone.Oscillator[] = [];
private unisonPanners: Tone.Panner[] = [];
private unisonGains: Tone.Gain[] = [];
private unisonEnvelope: Tone.AmplitudeEnvelope | null = null;
private unisonMixer: Tone.Gain | null = null;
```

**Add helper to calculate voice positions:**
```typescript
private getUnisonPositions(voiceCount: number): number[] {
  // Returns array of positions from -1 to 1
  // e.g., 4 voices: [-1, -0.33, 0.33, 1]
  const positions: number[] = [];
  for (let i = 0; i < voiceCount; i++) {
    positions.push((2 * i / (voiceCount - 1)) - 1);
  }
  return positions;
}
```

**Add createUnisonBank method:**
```typescript
private createUnisonBank(): void {
  this.disposeUnisonBank();

  const voiceCount = this.params.unison.voices;
  const positions = this.getUnisonPositions(voiceCount);

  // Create shared envelope and mixer
  this.unisonEnvelope = new Tone.AmplitudeEnvelope({
    attack: this.params.amplitudeEnvelope.attack,
    decay: this.params.amplitudeEnvelope.decay,
    sustain: this.params.amplitudeEnvelope.sustain,
    release: this.params.amplitudeEnvelope.release,
  });

  this.unisonMixer = new Tone.Gain(1 / voiceCount); // Normalize volume
  this.unisonEnvelope.connect(this.unisonMixer);
  this.unisonMixer.connect(this.synth.filter); // Route to existing filter

  // Create oscillators with panners
  for (let i = 0; i < voiceCount; i++) {
    const osc = new Tone.Oscillator({
      type: toToneOscillatorType(this.params.oscillator.type),
      frequency: this.currentFrequency,
    });

    const panner = new Tone.Panner(positions[i] * this.params.unison.spread);
    const gain = new Tone.Gain(1);

    osc.connect(gain);
    gain.connect(panner);
    panner.connect(this.unisonEnvelope);

    this.unisonOscs.push(osc);
    this.unisonPanners.push(panner);
    this.unisonGains.push(gain);
  }
}
```

**Add disposeUnisonBank method:**
```typescript
private disposeUnisonBank(): void {
  this.unisonOscs.forEach(osc => osc.dispose());
  this.unisonPanners.forEach(pan => pan.dispose());
  this.unisonGains.forEach(gain => gain.dispose());
  this.unisonEnvelope?.dispose();
  this.unisonMixer?.dispose();

  this.unisonOscs = [];
  this.unisonPanners = [];
  this.unisonGains = [];
  this.unisonEnvelope = null;
  this.unisonMixer = null;
}
```

**Add setUnison methods:**
```typescript
setUnisonEnabled(enabled: boolean): void {
  this.params.unison.enabled = enabled;
  if (enabled) {
    this.createUnisonBank();
    // Start oscillators (they'll be silent until envelope triggers)
    this.unisonOscs.forEach(osc => osc.start());
  } else {
    this.disposeUnisonBank();
  }
}

setUnisonVoices(voices: 2 | 4 | 8): void {
  this.params.unison.voices = voices;
  if (this.params.unison.enabled) {
    this.createUnisonBank();
    this.unisonOscs.forEach(osc => osc.start());
  }
}

setUnisonDetune(detune: number): void {
  this.params.unison.detune = detune;
  this.updateUnisonFrequencies();
}

setUnisonSpread(spread: number): void {
  this.params.unison.spread = spread;
  const positions = this.getUnisonPositions(this.params.unison.voices);
  this.unisonPanners.forEach((panner, i) => {
    panner.pan.value = positions[i] * spread;
  });
}
```

**Add updateUnisonFrequencies method:**
```typescript
private updateUnisonFrequencies(): void {
  if (!this.params.unison.enabled) return;

  const positions = this.getUnisonPositions(this.params.unison.voices);
  const baseFreq = this.currentFrequency;
  const detuneAmount = this.params.unison.detune;

  this.unisonOscs.forEach((osc, i) => {
    const cents = positions[i] * detuneAmount;
    osc.frequency.value = baseFreq * Math.pow(2, cents / 1200);
  });
}
```

**Modify triggerAttack to include unison:**
In the existing `triggerAttack` method, add:
```typescript
// Trigger unison if enabled
if (this.params.unison.enabled && this.unisonEnvelope) {
  this.updateUnisonFrequencies();
  this.unisonEnvelope.triggerAttack(time);
}
```

**Modify triggerRelease to include unison:**
```typescript
if (this.params.unison.enabled && this.unisonEnvelope) {
  this.unisonEnvelope.triggerRelease(time);
}
```

**Update oscillator type changes to include unison:**
In `setOscillatorType`, add:
```typescript
this.unisonOscs.forEach(osc => {
  osc.type = toToneOscillatorType(type);
});
```

**Update dispose to clean up unison:**
```typescript
this.disposeUnisonBank();
```

**Verification:** `npx tsc --noEmit`

---

## Task 3: Add Store Actions

**Files:**
- Modify: `src/ui/stores/synth-store.ts`

**Add to SynthStore interface:**
```typescript
setUnisonEnabled: (enabled: boolean) => void;
setUnisonVoices: (voices: 2 | 4 | 8) => void;
setUnisonDetune: (detune: number) => void;
setUnisonSpread: (spread: number) => void;
```

**Add implementations:**
```typescript
setUnisonEnabled: (enabled: boolean) => {
  set((state) => ({
    params: {
      ...state.params,
      unison: { ...state.params.unison, enabled },
    },
  }));
  get().engine?.setUnisonEnabled(enabled);
},

setUnisonVoices: (voices: 2 | 4 | 8) => {
  set((state) => ({
    params: {
      ...state.params,
      unison: { ...state.params.unison, voices },
    },
  }));
  get().engine?.setUnisonVoices(voices);
},

setUnisonDetune: (detune: number) => {
  set((state) => ({
    params: {
      ...state.params,
      unison: { ...state.params.unison, detune },
    },
  }));
  get().engine?.setUnisonDetune(detune);
},

setUnisonSpread: (spread: number) => {
  set((state) => ({
    params: {
      ...state.params,
      unison: { ...state.params.unison, spread },
    },
  }));
  get().engine?.setUnisonSpread(spread);
},
```

**Verification:** `npx tsc --noEmit`

---

## Task 4: Add UI

**Files:**
- Modify: `src/ui/views/SynthView.tsx`

**Add store bindings:**
```typescript
const {
  // ... existing
  setUnisonEnabled,
  setUnisonVoices,
  setUnisonDetune,
  setUnisonSpread,
} = useSynthStore();
```

**Add UNISON section after OSC1 controls (inside OSC1 StageCard):**
```tsx
{/* UNISON */}
<div style={{
  marginTop: SIZES.gap.md,
  padding: SIZES.gap.sm,
  background: params.unison.enabled ? 'rgba(59, 130, 246, 0.1)' : 'transparent',
  borderRadius: RADIUS.md,
  border: `1px solid ${params.unison.enabled ? COLORS.oscillator + '40' : 'transparent'}`,
}}>
  <div style={{
    display: 'flex',
    alignItems: 'center',
    gap: SIZES.gap.sm,
    marginBottom: params.unison.enabled ? SIZES.gap.sm : 0,
  }}>
    <span style={{
      fontSize: '10px',
      fontWeight: 600,
      color: COLORS.text.muted,
      textTransform: 'uppercase',
    }}>
      Unison
    </span>
    <button
      onClick={() => setUnisonEnabled(!params.unison.enabled)}
      style={{
        padding: '2px 8px',
        fontSize: '9px',
        fontWeight: 600,
        background: params.unison.enabled ? COLORS.oscillator : '#333',
        border: 'none',
        borderRadius: RADIUS.sm,
        color: '#fff',
        cursor: 'pointer',
      }}
    >
      {params.unison.enabled ? 'ON' : 'OFF'}
    </button>
  </div>

  {params.unison.enabled && (
    <div style={{ display: 'flex', gap: SIZES.gap.sm, alignItems: 'flex-start' }}>
      {/* Voice count selector */}
      <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>
        <span style={{ fontSize: '9px', color: COLORS.text.muted, textTransform: 'uppercase' }}>
          Voices
        </span>
        <div style={{ display: 'flex', gap: 2 }}>
          {([2, 4, 8] as const).map((v) => (
            <button
              key={v}
              onClick={() => setUnisonVoices(v)}
              style={{
                width: 24,
                height: 24,
                fontSize: '10px',
                fontWeight: 600,
                background: params.unison.voices === v ? COLORS.oscillator : '#333',
                border: 'none',
                borderRadius: RADIUS.sm,
                color: '#fff',
                cursor: 'pointer',
              }}
            >
              {v}
            </button>
          ))}
        </div>
      </div>

      {/* Detune knob */}
      <Knob
        label="Detune"
        value={params.unison.detune}
        min={0}
        max={100}
        step={1}
        onChange={setUnisonDetune}
        formatValue={(v) => `${v} ct`}
        paramId="unison.detune"
      />

      {/* Spread knob */}
      <Knob
        label="Spread"
        value={params.unison.spread}
        min={0}
        max={1}
        step={0.01}
        onChange={setUnisonSpread}
        formatValue={(v) => `${Math.round(v * 100)}%`}
        paramId="unison.spread"
      />
    </div>
  )}
</div>
```

**Verification:** `npx tsc --noEmit` and visual check in browser

---

## Task 5: Update Presets

**Files:**
- Modify: `src/data/presets/subtractive-presets.ts`

**Add unison defaults to all presets:**
```typescript
unison: {
  enabled: false,
  voices: 4,
  detune: 20,
  spread: 0.5,
},
```

**Add 1-2 presets that showcase unison:**
- "Super Saw" - saw wave, unison enabled, 8 voices, 25 detune, 0.8 spread
- "Wide Pad" - triangle wave, unison enabled, 4 voices, 15 detune, 0.6 spread, slow attack

**Verification:** `npx tsc --noEmit`

---

## Verification

After all tasks:
1. `npx tsc --noEmit` - no type errors
2. `bun test` - all tests pass
3. Manual test in browser:
   - Enable unison, play notes - should sound thicker
   - Change voices (2/4/8) - more voices = thicker
   - Adjust detune - higher = more chorus/detuned
   - Adjust spread - 0 = mono, 1 = wide stereo
   - Disable unison - should return to normal mono sound

---

## Files Summary

| File | Change |
|------|--------|
| `src/core/types.ts` | Add `UnisonParams`, update `SynthParams` |
| `src/core/synth-engine.ts` | Add unison oscillator bank + methods |
| `src/ui/stores/synth-store.ts` | Add unison actions |
| `src/ui/views/SynthView.tsx` | Add UNISON UI section |
| `src/data/presets/subtractive-presets.ts` | Add unison to presets |
